/// DAX Best Practice Validation Functions
/// Publisher: PQL (Power Query Lint)
/// These functions validate semantic models against best practices and performance recommendations
/// Asserts that no bi-directional relationships exist on high-cardinality columns.
/// For high-cardinality columns (>1M distinct values), bi-directional relationships can impact performance.
function 'PQL.Assert.BP.ShouldAvoidBiDirectionalOnHighCardinalityColumn' =
		() =>
		    VAR _CardinalityThreshold = 1000000
		    VAR _Relationships = INFO.VIEW.RELATIONSHIPS()
		    VAR _ColumnStats = COLUMNSTATISTICS()
		    VAR _BiDirectionalRels = 
		        FILTER(
		            _Relationships,
		            [CrossFilteringBehavior] = "BothDirections"
		        )
		    VAR _HighCardinalityBiDirRels = 
		        FILTER(
		            _BiDirectionalRels,
		            VAR _FromTable = [FromTable]
		            VAR _FromColumn = [FromColumn]
		            VAR _ToTable = [ToTable]
		            VAR _ToColumn = [ToColumn]
		            VAR _FromColumnCardinality = 
		                MAXX(
		                    FILTER(
		                        _ColumnStats,
		                        [Table Name] = _FromTable && [Column Name] = _FromColumn
		                    ),
		                    [Cardinality]
		                )
		            VAR _ToColumnCardinality = 
		                MAXX(
		                    FILTER(
		                        _ColumnStats,
		                        [Table Name] = _ToTable && [Column Name] = _ToColumn
		                    ),
		                    [Cardinality]
		                )
		            RETURN _FromColumnCardinality > _CardinalityThreshold || _ToColumnCardinality > _CardinalityThreshold
		        )
		    VAR _HighCardinalityCount = COUNTROWS(_HighCardinalityBiDirRels)
		    VAR _Passed = _HighCardinalityCount = 0
		    RETURN ROW(
		        "TestName", "[Performance] Avoid bi-directional relationships against high-cardinality columns",
		        "Expected", "No bi-directional relationships on high-cardinality columns (>1M)",
		        "Actual", IF(_HighCardinalityCount > 0, "BI-DIRECTIONAL RELATIONSHIPS ON HIGH-CARDINALITY COLUMNS FOUND (" & FORMAT(_HighCardinalityCount, "0") & ")", "NO HIGH-CARDINALITY BI-DIRECTIONAL RELATIONSHIPS"),
		        "Passed", _Passed,
		        "RuleDescription", "Avoid bi-directional relationships on high-cardinality columns (>1M distinct values) for better performance"
		    )
	annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5

/// Asserts that auto-date tables should be removed.
/// Auto-date tables (DateTableTemplate_* and LocalDateTable_*) consume memory and should be disabled.
function 'PQL.Assert.BP.ShouldRemoveAutoDateTable' =
		() =>
		    VAR _Tables = INFO.VIEW.TABLES()
		    VAR _AutoDateTableCount = 
		        COUNTROWS(
		            FILTER(
		                _Tables,
		                LEFT([Name], 18) = "DateTableTemplate_" || LEFT([Name], 15) = "LocalDateTable_"
		            )
		        )
		    VAR _Passed = _AutoDateTableCount = 0
		    RETURN ROW(
		        "TestName", "[Performance] Remove auto-date table",
		        "Expected", "No auto-date tables should exist in the model",
		        "Actual", IF(_AutoDateTableCount > 0, "AUTO-DATE TABLES FOUND (" & FORMAT(_AutoDateTableCount, "0") & ")", "NO AUTO-DATE TABLES"),
		        "Passed", _Passed,
		        "RuleDescription", "Avoid using auto-date tables. Turn off auto-date table in Power BI Desktop settings to save memory"
		    )
	annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5

/// Asserts that no columns use floating point data types.
/// The "Double" floating point data type should be avoided to prevent unpredictable roundoff errors and performance issues.
function 'PQL.Assert.BP.ShouldAvoidFloatingPointDataTypes' =
		() =>
		    VAR _Columns = INFO.VIEW.COLUMNS()
		    VAR _DoubleColumns = 
		        FILTER(
		            _Columns,
		            [DataType] = "Number"
		        )
		    VAR _DoubleColumnCount = COUNTROWS(_DoubleColumns)
		    VAR _ColumnsList = 
		        CONCATENATEX(
		            _DoubleColumns,
		            [Table] & "[" & [Name] & "]",
		            ", ",
		            [Table], ASC,
		            [Name], ASC
		        )
		    VAR _Passed = _DoubleColumnCount = 0
		    VAR _ActualMessage = 
		        IF(
		            _DoubleColumnCount > 0,
		            "NUMBER DATA TYPE COLUMNS FOUND (" & FORMAT(_DoubleColumnCount, "0") & "): " & _ColumnsList,
		            "NO NUMBER DATA TYPE COLUMNS"
		        )
		    RETURN ROW(
		        "TestName", "[Performance] Do not use floating point data types",
		        "Expected", "No columns should use Number data type",
		        "Actual", _ActualMessage,
		        "Passed", _Passed,
		        "RuleDescription", "Avoid using Number floating point data type, as it can result in unpredictable roundoff errors and decreased performance. Use Int64 or Decimal where appropriate (Decimal limited to 4 digits after decimal)"
		    )
	annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5

/// Asserts that IsAvailableInMdx should be set to false on non-attribute hidden columns.
/// Hidden columns should have IsAvailableInMdx set to false for better performance.
function 'PQL.Assert.BP.ShouldSetIsAvailableInMdxFalseOnNonAttributeColumns' =
		() =>
		    VAR _Columns = INFO.VIEW.COLUMNS()
		    VAR _Tables = INFO.VIEW.TABLES()
		    VAR _ViolatingColumns = 
		        FILTER(
		            _Columns,
		            VAR _CurrentTable = [Table]
		            VAR _IsHidden = [IsHidden]
		            VAR _IsAvailableInMDX = [IsAvailableInMDX]
		            VAR _TableIsHidden = 
		                COUNTROWS(
		                    FILTER(_Tables, [Name] = _CurrentTable && [IsHidden] = TRUE)
		                ) > 0
		            RETURN
		                _IsAvailableInMDX = TRUE
		                && (_IsHidden = FALSE && _TableIsHidden = FALSE)
		        )
		    VAR _ViolatingColumnCount = COUNTROWS(_ViolatingColumns)
		    VAR _ColumnsList = 
		        CONCATENATEX(
		            _ViolatingColumns,
		            [Table] & "[" & [Name] & "]",
		            ", ",
		            [Table], ASC,
		            [Name], ASC
		        )
		    VAR _Passed = _ViolatingColumnCount = 0
		    VAR _ActualMessage = 
		        IF(
		            _ViolatingColumnCount > 0,
		            "COLUMNS WITH ISAVAILABLEINMDX=TRUE FOUND (" & FORMAT(_ViolatingColumnCount, "0") & "): " & _ColumnsList,
		            "NO VIOLATING COLUMNS"
		        )
		    RETURN ROW(
		        "TestName", "[Performance] Set IsAvailableInMdx to false on non-attribute columns",
		        "Expected", "Hidden columns should have IsAvailableInMdx = false",
		        "Actual", _ActualMessage,
		        "Passed", _Passed,
		        "RuleDescription", "To speed up processing time and conserve memory, attribute hierarchies should not be built for hidden columns. Set IsAvailableInMdx to false for better performance"
		    )
	annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5

/// Runs all performance best practice checks.
/// This function executes all performance validation rules and returns combined results.
function 'PQL.Assert.BP.CheckPerformance' =
		() =>
		    UNION(
		        PQL.Assert.BP.ShouldAvoidBiDirectionalOnHighCardinalityColumn(),
		        PQL.Assert.BP.ShouldRemoveAutoDateTable(),
		        PQL.Assert.BP.ShouldAvoidFloatingPointDataTypes(),
		        PQL.Assert.BP.ShouldSetIsAvailableInMdxFalseOnNonAttributeColumns()
		    )
	annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5
