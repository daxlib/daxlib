/// Error Prevention Best Practice Validation Functions
/// Publisher: PQL (Power Query Lint)
/// These functions validate semantic models against error prevention best practices
/// Asserts that relationship columns should be of the same data type.
/// Columns used in a relationship should be of the same data type. Having columns within a relationship which are of different data types may lead to various issues.
function 'PQL.Assert.BP.ShouldHaveSameDataTypeInRelationships' =
		() =>
		    VAR _Relationships = INFO.VIEW.RELATIONSHIPS()
		    VAR _Columns = INFO.VIEW.COLUMNS()
		    
		    // Create a lookup for column data types
		    VAR _ColumnDataTypes = 
		        SUMMARIZE(
		            _Columns,
		            [Table],
		            [Name],
		            [DataType]
		        )
		    
		    // Check each relationship for data type mismatches
		    VAR _ViolatingRelationships = 
		        FILTER(
		            _Relationships,
		            VAR _FromTable = [FromTable]
		            VAR _FromColumn = [FromColumn]
		            VAR _ToTable = [ToTable]
		            VAR _ToColumn = [ToColumn]
		            
		            // Get data type of FromColumn
		            VAR _FromDataType = 
		                MAXX(
		                    FILTER(
		                        _ColumnDataTypes,
		                        [Table] = _FromTable && [Name] = _FromColumn
		                    ),
		                    [DataType]
		                )
		            
		            // Get data type of ToColumn
		            VAR _ToDataType = 
		                MAXX(
		                    FILTER(
		                        _ColumnDataTypes,
		                        [Table] = _ToTable && [Name] = _ToColumn
		                    ),
		                    [DataType]
		                )
		            
		            // Check if data types are different
		            RETURN 
		                NOT ISBLANK(_FromDataType) 
		                && NOT ISBLANK(_ToDataType)
		                && _FromDataType <> _ToDataType
		        )
		    
		    VAR _ViolationCount = COUNTROWS(_ViolatingRelationships)
		    
		    VAR _RelationshipsList = 
		        CONCATENATEX(
		            _ViolatingRelationships,
		            [FromTable] & "[" & [FromColumn] & "] -> " & [ToTable] & "[" & [ToColumn] & "]",
		            ", ",
		            [FromTable], ASC,
		            [FromColumn], ASC
		        )
		    
		    VAR _Passed = _ViolationCount = 0
		    
		    VAR _ActualMessage = 
		        IF(
		            _ViolationCount > 0,
		            "RELATIONSHIPS WITH MISMATCHED DATA TYPES FOUND (" & FORMAT(_ViolationCount, "0") & "): " & _RelationshipsList,
		            "ALL RELATIONSHIP COLUMNS HAVE MATCHING DATA TYPES"
		        )
		    
		    RETURN ROW(
		        "TestName", "[Error Prevention] Relationship columns should be of the same data type",
		        "Expected", "All relationship columns should have matching data types",
		        "Actual", _ActualMessage,
		        "Passed", _Passed,
		        "RuleDescription", "Columns used in a relationship should be of the same data type. Ideally, they will be of integer data type. Having columns within a relationship which are of different data types may lead to various issues including slower performance and unexpected query results. Severity: High (3)."
		    )	
    annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5
/// Runs all error prevention best practice checks.
/// This function executes all error prevention validation rules and returns combined results.
function 'PQL.Assert.BP.CheckErrorPrevention' =
		() =>
		    PQL.Assert.BP.ShouldHaveSameDataTypeInRelationships()
	annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5
