/// Formatting Best Practice Validation Functions
/// Publisher: PQL (Power Query Lint)
/// These functions validate semantic models against formatting best practices
/// Asserts that visible measures should have their format string property assigned.
/// Measures without format strings may display inconsistently and make reports harder to understand.
function 'PQL.Assert.BP.ShouldProvideFormatStringForMeasures' =
		() =>
		    VAR _ViewMeasures = INFO.VIEW.MEASURES()
		    VAR _Measures = INFO.MEASURES()
		    VAR _Tables = INFO.VIEW.TABLES()
		    
		    // Create a lookup for hidden tables
		    VAR _HiddenTables = 
		        FILTER(
		            _Tables,
		            [IsHidden] = TRUE
		        )
		    
		    // Check measures for missing format strings
		    VAR _ViolatingMeasures = 
		        FILTER(
		            _ViewMeasures,
		            VAR _TableName = [Table]
		            VAR _MeasureID = [ID]
		            
		            // Get FormatString from INFO.MEASURES()
		            VAR _FormatString = 
		                MAXX(
		                    FILTER(
		                        _Measures,
		                        [ID] = _MeasureID
		                    ),
		                    [FormatString]
		                )
		            
		            // Check if table is hidden
		            VAR _TableIsHidden = 
		                COUNTROWS(
		                    FILTER(
		                        _HiddenTables,
		                        [Name] = _TableName
		                    )
		                ) > 0
		            
		            // Measure is on a visible table and has no format string
		            RETURN 
		                NOT _TableIsHidden
		                && (ISBLANK(_FormatString) || _FormatString = "")
		        )
		    
		    VAR _ViolationCount = COUNTROWS(_ViolatingMeasures)
		    
		    VAR _MeasuresList = 
		        CONCATENATEX(
		            _ViolatingMeasures,
		            [Table] & "[" & [Name] & "]",
		            ", ",
		            [Table], ASC,
		            [Name], ASC
		        )
		    
		    VAR _Passed = _ViolationCount = 0
		    
		    VAR _ActualMessage = 
		        IF(
		            _ViolationCount > 0,
		            "MEASURES WITHOUT FORMAT STRING FOUND (" & FORMAT(_ViolationCount, "0") & "): " & _MeasuresList,
		            "ALL VISIBLE MEASURES HAVE FORMAT STRINGS ASSIGNED"
		        )
		    
		    RETURN ROW(
		        "TestName", "[Formatting] Provide format string for measures",
		        "Expected", "All visible measures should have format strings assigned",
		        "Actual", _ActualMessage,
		        "Passed", _Passed,
		        "RuleDescription", "Visible measures should have their format string property assigned. Measures without format strings may display inconsistently and make reports harder to understand. Severity: High (3)."
		    )	
    annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5
/// Asserts that numeric columns should have SummarizeBy set to None.
/// Numeric columns with SummarizeBy enabled may cause accidental aggregation in reports. Users should create explicit measures instead.
function 'PQL.Assert.BP.ShouldNotSummarizeNumericColumns' =
		() =>
		    VAR _Columns = INFO.VIEW.COLUMNS()
		    VAR _Tables = INFO.VIEW.TABLES()
		    
		    // Create a lookup for hidden tables
		    VAR _HiddenTables = 
		        FILTER(
		            _Tables,
		            [IsHidden] = TRUE
		        )
		    
		    // Check numeric columns with SummarizeBy not set to None
		    VAR _ViolatingColumns = 
		        FILTER(
		            _Columns,
		            VAR _TableName = [Table]
		            VAR _DataType = [DataType]
		            VAR _IsHidden = [IsHidden]
		            VAR _SummarizeBy = [SummarizeBy]
		            
		            // Check if table is hidden
		            VAR _TableIsHidden = 
		                COUNTROWS(
		                    FILTER(
		                        _HiddenTables,
		                        [Name] = _TableName
		                    )
		                ) > 0
		            
		            // Column is numeric (Int64, Decimal, or Double)
		            VAR _IsNumeric = 
		                _DataType = "Integer"
		                || _DataType = "Currency"
		                || _DataType = "Number"
		            
		            // Check if SummarizeBy is not set to None
		            RETURN 
		                _IsNumeric
		                && NOT _IsHidden
		                && NOT _TableIsHidden
		                && _SummarizeBy <> "None"
		        )
		    
		    VAR _ViolationCount = COUNTROWS(_ViolatingColumns)
		    
		    VAR _ColumnsList = 
		        CONCATENATEX(
		            _ViolatingColumns,
		            [Table] & "[" & [Name] & "] (SummarizeBy: " & [SummarizeBy] & ")",
		            ", ",
		            [Table], ASC,
		            [Name], ASC
		        )
		    
		    VAR _Passed = _ViolationCount = 0
		    
		    VAR _ActualMessage = 
		        IF(
		            _ViolationCount > 0,
		            "NUMERIC COLUMNS WITH SUMMARIZE BY FOUND (" & FORMAT(_ViolationCount, "0") & "): " & _ColumnsList,
		            "ALL NUMERIC COLUMNS HAVE SUMMARIZE BY SET TO NONE"
		        )
		    
		    RETURN ROW(
		        "TestName", "[Formatting] Do not summarize numeric columns",
		        "Expected", "Numeric columns should have SummarizeBy set to None",
		        "Actual", _ActualMessage,
		        "Passed", _Passed,
		        "RuleDescription", "Numeric columns (Int64, Decimal, Double) should have their SummarizeBy property set to None to avoid accidental aggregation in Power BI. Users should create explicit measures instead. Severity: High (3)."
		    )	
    annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5
/// Runs all formatting best practice checks.
/// This function executes all formatting validation rules and returns combined results.
function 'PQL.Assert.BP.CheckFormatting' =
		() =>
		    UNION(
		        PQL.Assert.BP.ShouldProvideFormatStringForMeasures(),
		        PQL.Assert.BP.ShouldNotSummarizeNumericColumns()
		    )
	annotation DAXLIB_PackageId = PQL.Assert
	annotation DAXLIB_PackageVersion = 0.1.5
